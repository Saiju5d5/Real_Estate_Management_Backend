<!DOCTYPE html>
<html class="light" lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Add Property - EstateManager</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet"/>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#137fec",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"],
                        "sans": ["Inter", "sans-serif"],
                    },
                    borderRadius: {"DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px"},
                },
            },
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark text-[#0d141b] dark:text-white h-screen flex overflow-hidden font-display">
    <aside class="w-64 bg-white dark:bg-[#1A2632] border-r border-[#e7edf3] dark:border-slate-800 flex flex-col shrink-0 transition-all duration-300">
        <div class="h-16 flex items-center px-6 border-b border-[#e7edf3] dark:border-slate-800">
            <div class="flex items-center gap-3 text-[#0d141b] dark:text-white">
                <div class="flex size-8 items-center justify-center rounded-lg bg-primary text-white">
                    <span class="material-symbols-outlined text-xl">real_estate_agent</span>
                </div>
                <h2 class="text-[#0d141b] dark:text-white text-lg font-bold leading-tight tracking-[-0.015em]">EstateManager</h2>
            </div>
        </div>
        <nav class="flex-1 overflow-y-auto py-6 px-4 space-y-2">
            <a th:href="@{/agent/dashboard}" class="flex items-center gap-3 px-3 py-2 text-slate-600 dark:text-slate-400 hover:text-primary hover:bg-slate-50 dark:hover:bg-slate-800 rounded-lg transition-colors group">
                <span class="material-symbols-outlined">dashboard</span>
                <span class="font-medium text-sm">Dashboard</span>
            </a>
            <a th:href="@{/agent/my-properties}" class="flex items-center gap-3 px-3 py-2 text-slate-600 dark:text-slate-400 hover:text-primary hover:bg-slate-50 dark:hover:bg-slate-800 rounded-lg transition-colors group">
                <span class="material-symbols-outlined">home</span>
                <span class="font-medium text-sm">My Properties</span>
            </a>
            <a th:href="@{/agent/profile}" class="flex items-center gap-3 px-3 py-2 text-slate-600 dark:text-slate-400 hover:text-primary hover:bg-slate-50 dark:hover:bg-slate-800 rounded-lg transition-colors group">
                <span class="material-symbols-outlined group-hover:text-primary transition-colors">manage_accounts</span>
                <span class="font-medium text-sm">Profile Management</span>
            </a>
        </nav>
        <div class="p-4 border-t border-[#e7edf3] dark:border-slate-800">
            <button onclick="logout()" class="w-full flex items-center gap-2 text-slate-600 dark:text-slate-400 hover:text-red-500 py-2 text-sm font-medium transition-colors">
                <span class="material-symbols-outlined">logout</span>
                <span>Log Out</span>
            </button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-full overflow-hidden bg-background-light dark:bg-background-dark relative">
        <div class="flex-1 overflow-y-auto p-8">
            <div class="max-w-3xl mx-auto flex flex-col gap-8">
                <div class="flex flex-col gap-6">
                    <div class="flex flex-wrap gap-2 items-center text-sm">
                        <a th:href="@{/agent/dashboard}" class="text-slate-500 dark:text-slate-400 hover:text-primary font-medium flex items-center gap-1">Dashboard</a>
                        <span class="text-slate-400 material-symbols-outlined text-[16px]">chevron_right</span>
                        <span class="text-[#0d141b] dark:text-white font-medium">Add New</span>
                    </div>
                    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                        <div class="flex flex-col gap-1">
                            <h1 class="text-[#0d141b] dark:text-white text-3xl font-black leading-tight tracking-[-0.033em]">Add New Property</h1>
                            <p class="text-slate-500 dark:text-slate-400 text-base font-normal">Fill in the details below to list a new property.</p>
                        </div>
                        <div class="flex gap-3">
                            <button id="publish-btn" type="button" class="px-6 py-2.5 rounded-lg bg-primary text-white font-medium hover:bg-blue-600 transition-colors shadow-sm flex items-center gap-2">
                                <span class="material-symbols-outlined text-[20px]">publish</span> Publish Property
                            </button>
                        </div>
                    </div>
                </div>

                <form id="property-form" class="flex flex-col gap-6">
                    <div class="bg-white dark:bg-[#1e293b] rounded-xl shadow-sm border border-slate-100 dark:border-slate-700/50 p-6 flex flex-col gap-6">
                        <div class="flex items-center gap-2 border-b border-slate-100 dark:border-slate-700 pb-4">
                            <span class="material-symbols-outlined text-primary">info</span>
                            <h2 class="text-[#0d141b] dark:text-white text-lg font-bold">Basic Information</h2>
                        </div>
                        <div class="flex flex-col gap-6">
                            <label class="flex flex-col gap-2">
                                <span class="text-[#0d141b] dark:text-slate-200 text-sm font-medium">Property Title <span class="text-red-500">*</span></span>
                                <input id="title" type="text" class="w-full rounded-lg border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-800/50 text-[#0d141b] dark:text-white focus:ring-2 focus:ring-primary/20 focus:border-primary p-3 text-base" placeholder="e.g. Modern Sunset Villa" required/>
                            </label>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <label class="flex flex-col gap-2">
                                    <span class="text-[#0d141b] dark:text-slate-200 text-sm font-medium">Price <span class="text-red-500">*</span></span>
                                    <div class="relative">
                                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500 font-medium">$</span>
                                        <input id="price" type="number" step="0.01" min="0" class="w-full rounded-lg border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-800/50 text-[#0d141b] dark:text-white focus:ring-2 focus:ring-primary/20 pl-7 p-3 text-base" placeholder="0.00" required/>
                                    </div>
                                </label>
                                <label class="flex flex-col gap-2">
                                    <span class="text-[#0d141b] dark:text-slate-200 text-sm font-medium">Property Type <span class="text-red-500">*</span></span>
                                    <select id="type" class="w-full rounded-lg border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-800/50 text-[#0d141b] dark:text-white focus:ring-2 focus:ring-primary/20 p-3 pr-10 text-base appearance-none cursor-pointer" required>
                                        <option value="">Select type</option>
                                        <option value="rent">For Rent</option>
                                        <option value="buy">For Sale</option>
                                    </select>
                                </label>
                            </div>
                            <label class="flex flex-col gap-2">
                                <span class="text-[#0d141b] dark:text-slate-200 text-sm font-medium">Location / Address <span class="text-red-500">*</span></span>
                                <div class="relative">
                                    <input id="location" type="text" class="w-full rounded-lg border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-800/50 text-[#0d141b] dark:text-white focus:ring-2 focus:ring-primary/20 pl-10 p-3 text-base" placeholder="Start typing address..." required/>
                                    <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">location_on</span>
                                </div>
                            </label>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-[#1e293b] rounded-xl shadow-sm border border-slate-100 dark:border-slate-700/50 p-6 flex flex-col gap-6">
                        <div class="flex items-center gap-2 border-b border-slate-100 dark:border-slate-700 pb-4">
                            <span class="material-symbols-outlined text-primary">description</span>
                            <h2 class="text-[#0d141b] dark:text-white text-lg font-bold">Description</h2>
                        </div>
                        <label class="flex flex-col gap-2">
                            <span class="text-[#0d141b] dark:text-slate-200 text-sm font-medium">Property Description</span>
                            <textarea id="description" rows="4" class="w-full rounded-lg border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-800/50 text-[#0d141b] dark:text-white focus:ring-2 focus:ring-primary/20 p-3 text-base min-h-[160px]" placeholder="Describe the property features..."></textarea>
                        </label>
                    </div>

                    <div class="bg-white dark:bg-[#1e293b] rounded-xl shadow-sm border border-slate-100 dark:border-slate-700/50 p-6 flex flex-col gap-6">
                        <div class="flex items-center gap-2 border-b border-slate-100 dark:border-slate-700 pb-4">
                            <span class="material-symbols-outlined text-primary">photo_library</span>
                            <h2 class="text-[#0d141b] dark:text-white text-lg font-bold">Gallery</h2>
                        </div>
                        <div class="flex flex-col gap-4">
                            <div onclick="document.getElementById('image-upload').click()" class="border-2 border-dashed border-slate-200 dark:border-slate-600 rounded-xl p-8 flex flex-col items-center justify-center gap-4 hover:border-primary hover:bg-blue-50/50 dark:hover:bg-slate-800/50 transition-all cursor-pointer group">
                                <div class="bg-slate-50 dark:bg-slate-800 p-4 rounded-full group-hover:scale-110 transition-transform">
                                    <span class="material-symbols-outlined text-4xl text-primary">cloud_upload</span>
                                </div>
                                <div class="text-center">
                                    <p class="text-[#0d141b] dark:text-white font-semibold">Click to upload or drag and drop</p>
                                    <p class="text-slate-500 dark:text-slate-400 text-sm mt-1">PNG, JPG or GIF (max. 10MB per file)</p>
                                </div>
                                <input id="image-upload" accept="image/*" class="hidden" multiple type="file"/>
                            </div>
                            <div id="image-preview" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
                        </div>
                    </div>
                </form>
                <div class="h-10"></div>
            </div>
        </div>
    </main>

    <script th:src="@{/js/config/api.js}"></script>
    <script th:src="@{/js/config/auth.js}"></script>
    <script th:src="@{/js/utils/role-guard.js}"></script>
    <script th:src="@{/js/services/property.service.js}"></script>
    <script th:src="@{/js/services/upload.service.js}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (!RoleGuard.requireAgent()) return;

            const imageInput = document.getElementById('image-upload');
            const imagePreview = document.getElementById('image-preview');
            let uploadedImages = [];

            imageInput.addEventListener('change', async (e) => {
                const files = Array.from(e.target.files);
                for (const file of files) {
                    const validation = uploadService.validateImage(file);
                    if (!validation.valid) {
                        showNotification(validation.error, 'error');
                        continue;
                    }

                    try {
                        const imageUrl = await uploadService.uploadImage(file);
                        uploadedImages.push(imageUrl);
                        displayPreviewImage(imageUrl, imagePreview);
                    } catch (error) {
                        showNotification('Failed to upload: ' + error.message, 'error');
                    }
                }
            });

            document.getElementById('publish-btn').addEventListener('click', handleSubmit);
        });

        function displayPreviewImage(imageUrl, container) {
            const div = document.createElement('div');
            div.className = 'relative group';
            div.innerHTML = `
                <img src="${imageUrl}" alt="Preview" class="w-full h-32 object-cover rounded-lg border border-slate-200 dark:border-slate-700"/>
                <button type="button" onclick="this.parentElement.remove(); uploadedImages = uploadedImages.filter(img => img !== '${imageUrl}');" class="absolute top-2 right-2 p-1 bg-red-500 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity">
                    <span class="material-symbols-outlined text-sm">close</span>
                </button>
            `;
            container.appendChild(div);
        }

        let uploadedImages = [];

        async function handleSubmit() {
            const form = document.getElementById('property-form');
            const title = document.getElementById('title').value.trim();
            const price = document.getElementById('price').value;
            const type = document.getElementById('type').value;
            const location = document.getElementById('location').value.trim();
            const description = document.getElementById('description').value.trim();
            const publishBtn = document.getElementById('publish-btn');

            if (!title || !price || !type || !location) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }

            try {
                publishBtn.disabled = true;
                publishBtn.innerHTML = '<span class="material-symbols-outlined text-[20px] animate-spin">hourglass_empty</span> Publishing...';

                const propertyData = {
                    title: title,
                    description: description,
                    price: parseFloat(price),
                    location: location,
                    type: type,
                    images: uploadedImages
                };

                await propertyService.createProperty(propertyData);
                showNotification('Property created successfully!', 'success');
                setTimeout(() => {
                    window.location.href = '/agent/my-properties';
                }, 1500);
            } catch (error) {
                showNotification(error.message || 'Failed to create property', 'error');
                publishBtn.disabled = false;
                publishBtn.innerHTML = '<span class="material-symbols-outlined text-[20px]">publish</span> Publish Property';
            }
        }

        function logout() {
            authService.logout();
        }
    </script>
</body>
</html>
